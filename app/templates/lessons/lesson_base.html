{% extends "base.html" %}

{% block scripts %}
<script src="{{ url_for('static', filename='learn/utils.js') }}"></script>
<script>
	// stages format:
	// [{puzzleData:{fen, eventColor, moveTree}, text: [string], isFlipped: bool, scriptFirstMove: bool}]

	DEFAULT_LESSON_OPTIONS = {
		textTarget: "#puzzle-text",
		nextButtonTarget: "#next-button",
		backButtonTarget: "#back-button",
		boardTarget: "#board"
	}

	async function runLesson(stages, options, boardOptions) {
		const text = getElement(options.textTarget);
		const nextButton = getElement(options.nextButtonTarget);
		const backButton = getElement(options.backButtonTarget);
		let buttonLock = false

		const lessonData = await getLessonData({{ lesson_id }});
		let maxProgression = 0;
		let stage = 0;
		if (lessonData === null) {
			console.log("error! couldnt fetch lesson data from the server");
		}
		else {
			maxProgression = lessonData.completed_lesson ? stages.length - 1 : lessonData.progression;
			stage = lessonData.progression;
			console.log(stage);
		}
		let step = 0;

		function onNextBtn() {
			if (stage < maxProgression && !buttonLock) {
				stage++;
				setLessonStage(stage);
				updateButtons();
				setLessonProgression({{ lesson_id }}, stage);
				console.log(`update progression to ${stage}`)
			}
		}
		nextButton.onclick = onNextBtn;

		function updateButtons() {
			if (stage === 0) {
				backButton.classList.add("ac-disable-access");
			}
			else {
				backButton.classList.remove("ac-disable-access");
			}

			if (stage === stages.length - 1) {
				nextButton.classList.remove("ac-disable-access");
				nextButton.innerText = "Complete";
				nextButton.onclick = () => {
				markLessonAsComplete({{ lesson_id }}).then(() => {
						// Complete
						window.location.href = "{{ url_for('learn') }}";
					});
				}
			}
			else {
				nextButton.innerText = "Next";
				nextButton.onclick = onNextBtn;
				if (stage === maxProgression) {
					nextButton.classList.add("ac-disable-access");
				}
				else {
					nextButton.classList.remove("ac-disable-access");
				}
			}

		}

		updateButtons();

		const puzzle = new Puzzle({
			boardOptions: {
				target: options.boardTarget,
				allowUndo: false,
				...boardOptions,
			},
			...stages[stage].puzzleData
		});
		puzzle.board.position.isAtomic = true;

		function setLessonStage(_stage) {
			if (stages[stage].scriptFirstMove) {
				buttonLock = true;
				puzzle.board.disableInteraction();
				wait(1000).then(() => {
					puzzle.playContinuation();
					if (step !== stages[stage].text.length - 1) { // dont bother re-enabling interaction if its the last step of the puzzle
						puzzle.board.enableInteraction();
					}
					puzzle.board.waitForAnimation().then(() =>{
						buttonLock = false;
					});
				});
			}

			puzzle.board.emphasizer.resetColors();
			puzzle.board.enableInteraction();
			puzzle.board.setFlip(stages[_stage].isFlipped);

			step = 0;
			puzzle.setFromData(stages[_stage].puzzleData);
			text.innerText = stages[_stage].text[step];
		}

		setLessonStage(stage, false);

		puzzle.correctMovePlayed.addEventListener((move) => {
			console.log("correct move");

			puzzle.board.emphasizer.setColors("#00a00088", "#00700088");

			if (!puzzle.isComplete()) {
				puzzle.board.disableInteraction();
				buttonLock = true;
				wait(1000).then(() => {
					step++;
					text.innerText = stages[stage].text[step];

					puzzle.board.emphasizer.resetColors();
					puzzle.board.enableInteraction();
					puzzle.playContinuation();

					puzzle.board.waitForAnimation().then(() => {
						buttonLock = false;
					});
				});
			}
		});

		puzzle.incorrectMovePlayed.addEventListener((move) => {
			console.log("wrong move");

			puzzle.board.disableInteraction();
			puzzle.board.emphasizer.setColors("#ff000088", "#aa000088");
			buttonLock = true;
			wait(500).then(() => {
				puzzle.board.emphasizer.resetColors();
				puzzle.board.enableInteraction();
				puzzle.board.undoLastMove(true);

				puzzle.board.waitForAnimation().then(() => {
					buttonLock = false;
				});
			});
		});

		puzzle.puzzleComplete.addEventListener(() => {
			console.log("puzzle complete");
			if (stage === maxProgression) {
				maxProgression++;
				updateButtons();
			}

			puzzle.board.disableInteraction();
		})

		backButton.onclick = () => {
			if (stage > 0 && !buttonLock) {
				stage--;
				setLessonStage(stage);
				updateButtons();
			}
		}
	}
</script>
{% endblock %}
